<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CÂY PHẢ HỆ HỌ BÙI – Mobile v5.0 (lọc theo đời + độ sâu + focus nhánh)</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg: #0a0f1a;
    --surface: #0f1626;
    --card: #121b31;
    --text: #eef2ff;
    --muted:#9aa4b2;
    --border:#22345e;
    --radius:16px;

    --g1:#ff6b6b;   --g1bg:#2a1216;
    --g2:#55d187;   --g2bg:#14281d;
    --g3:#e5c355;   --g3bg:#2b2613;
    --g4:#6aa7ff;   --g4bg:#0f223c;
    --g5:#d48cff;   --g5bg:#27113a;
    --g6:#4fd1c5;   --g6bg:#0e2b2a;
    --g7:#f59e6b;   --g7bg:#2b1f14;
    --g8:#8bd1ff;   --g8bg:#0d2738;
    --g9:#ffc98b;   --g9bg:#2e2412;
    --g10:#8cff8a;  --g10bg:#0e2b12;
    --g11:#ff8bd8;  --g11bg:#2a1026;
    --g12:#c6a6ff;  --g12bg:#251a38;
    --g13:#7fe7ff;  --g13bg:#102932;
    --g14:#ffd77a;  --g14bg:#2f2812;
  }

  /* Base */
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:0 auto 64px;}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(10,15,26,.95), rgba(10,15,26,.75));backdrop-filter:blur(8px);border-bottom:1px solid var(--border);}
  .pad{padding:10px 12px}
  .title{font-weight:800;font-size:18px;letter-spacing:.2px;margin:0 0 6px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search{flex:1;display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .search input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:15px;min-width:120px}
  .btn{border:1px solid var(--border);background:#162246;color:#dbe3ff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:13px;touch-action:manipulation}
  .btn:active{transform:translateY(1px)}
  .legend{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .note{font-size:12px;color:var(--muted);margin-top:6px}

  /* Gen bar & secondary actions */
  .gens{display:flex;gap:6px;overflow:auto;padding:6px 12px;border-top:1px solid var(--border);background:rgba(18,27,49,.6)}
  .gbtn{border:1px solid var(--border);background:#0f172a;color:#dbe5ff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;white-space:nowrap;touch-action:manipulation}
  .gbtn.active{background:#1d2a52}
  .sep{width:1px;background:var(--border);height:28px;align-self:center}
  .bar-actions{display:flex;gap:6px;padding:6px 12px;border-top:1px solid var(--border);background:rgba(18,27,49,.6);align-items:center;flex-wrap:wrap}
  .depth{display:flex;align-items:center;gap:8px;margin-left:auto}
  .depth input[type="range"]{width:140px}

  /* Floating bottom toolbar (mobile convenience) */
  .fabbar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;background:rgba(18,27,49,.9);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:999px;padding:6px 8px;z-index:60}
  .fabbar .btn{padding:8px 10px}

  /* Tree */
  .tree{padding:12px}
  details{margin:10px 0 0 0}
  details>summary{list-style:none;cursor:pointer}
  details>summary::-webkit-details-marker{display:none}
  .node{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border); border-radius:16px;padding:12px; background:var(--card);box-shadow:0 10px 24px rgba(0,0,0,.25);position:relative}
  .node .actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
  .node .mini{font-size:11px;padding:4px 8px;border-radius:999px;background:#0e1938;border:1px solid var(--border);color:#cfe1ff;cursor:pointer}
  .meta{font-size:12px;color:var(--muted);margin-top:2px}
  .count{margin-left:auto;background:#0e1938;border:1px solid var(--border);padding:0 8px;border-radius:999px;font-size:12px;color:#cfe1ff;height:22px;display:inline-flex;align-items:center}
  .children{margin-left:18px;border-left:2px dashed var(--border);padding-left:12px;margin-top:8px}
  .children .children{margin-left:16px}
  .children .children .children{margin-left:14px}
  .children .children .children .children{margin-left:12px}
  .children .children .children .children .children{margin-left:10px}
  .leaf{margin:8px 0 0 26px;padding:10px 12px;border-left:3px solid var(--border);background:var(--surface);border-radius:10px;position:relative}

  .hidden{display:none !important}
  .focus-dim{opacity:.16;filter:saturate(.4)}

  [data-gen="1"]>.node{border-left:6px solid var(--g1); background:linear-gradient(90deg, var(--g1bg), transparent)}
  [data-gen="2"]>.node{border-left:6px solid var(--g2); background:linear-gradient(90deg, var(--g2bg), transparent)}
  [data-gen="3"]>.node{border-left:6px solid var(--g3); background:linear-gradient(90deg, var(--g3bg), transparent)}
  [data-gen="4"]>.node{border-left:6px solid var(--g4); background:linear-gradient(90deg, var(--g4bg), transparent)}
  [data-gen="5"]>.node{border-left:6px solid var(--g5); background:linear-gradient(90deg, var(--g5bg), transparent)}
  [data-gen="6"]>.node{border-left:6px solid var(--g6); background:linear-gradient(90deg, var(--g6bg), transparent)}
  [data-gen="7"]>.node{border-left:6px solid var(--g7); background:linear-gradient(90deg, var(--g7bg), transparent)}
  [data-gen="8"]>.node{border-left:6px solid var(--g8); background:linear-gradient(90deg, var(--g8bg), transparent)}
  [data-gen="9"]>.node{border-left:6px solid var(--g9); background:linear-gradient(90deg, var(--g9bg), transparent)}
  [data-gen="10"]>.node{border-left:6px solid var(--g10); background:linear-gradient(90deg, var(--g10bg), transparent)}
  [data-gen="11"]>.node{border-left:6px solid var(--g11); background:linear-gradient(90deg, var(--g11bg), transparent)}
  [data-gen="12"]>.node{border-left:6px solid var(--g12); background:linear-gradient(90deg, var(--g12bg), transparent)}
  [data-gen="13"]>.node{border-left:6px solid var(--g13); background:linear-gradient(90deg, var(--g13bg), transparent)}
  [data-gen="14"]>.node{border-left:6px solid var(--g14); background:linear-gradient(90deg, var(--g14bg), transparent)}

  .chev{width:12px;height:12px;display:inline-block;border-right:2px solid #8ea6ff;border-bottom:2px solid #8ea6ff;transform:rotate(-45deg);transition:transform .2s ease;margin-right:6px}
  details[open]>summary .chev{transform:rotate(45deg)}

  mark{background:#fde04733;border:1px solid #fde04755;border-radius:4px;padding:0 2px}

  /* Compact mode actually shrinks things now */
  .compact .node{padding:10px;border-radius:12px}
  .compact .leaf{padding:8px 10px;border-radius:8px}
  .compact .children{padding-left:8px;margin-left:12px}
  .compact .node .actions{right:6px;bottom:6px}
  .compact .title{font-size:16px}
  .compact .search input{font-size:14px}
  .compact .btn{padding:6px 10px;font-size:12px}

  /* Print-friendly */
  @media print{
    .topbar,.fabbar{display:none !important}
    body{background:#fff;color:#000}
    .node,.leaf{break-inside:avoid}
  }

  /* Respect prefers-reduced-motion */
  @media (prefers-reduced-motion:reduce){
    *{scroll-behavior:auto !important;transition:none !important}
  }
</style>
</head>
<body>
<div class="topbar" role="banner">
  <div class="pad">
    <div class="title">CÂY PHẢ HỆ HỌ BÙI – Mobile v5.0</div>
    <div class="row">
      <div class="search" style="flex:1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#8ea6ff" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#8ea6ff" stroke-width="2" fill="none"/></svg>
        <input id="q" placeholder="Tìm tên người, địa danh…" aria-label="Tìm kiếm">
        <button id="clear" class="btn" type="button">Xóa</button>
      </div>
      <button class="btn" id="expand" type="button">Mở tất cả</button>
      <button class="btn" id="collapse" type="button">Thu tất cả</button>
      <button class="btn" id="toggleCompact" type="button">Chế độ nén</button>
    </div>
    <div class="note">Mẹo: Nhấn nút "Đời N" để ẩn/hiện đời đó. Nếu lỡ ẩn, nhấn lại để bật lại hoặc dùng “Hiện tất cả đời”. Bạn có thể <strong>Focus</strong> vào 1 nhánh để đọc rõ trên điện thoại.</div>
  </div>

  <!-- Gen bar -->
  <div class="gens" id="genbar" aria-label="Lọc theo đời (chọn để ẩn/hiện)"></div>

  <!-- Secondary actions -->
  <div class="bar-actions">
    <button class="btn" id="showAllGen" type="button">Hiện tất cả đời</button>
    <button class="btn" id="singleModeBtn" aria-pressed="false" type="button">Chế độ chỉ đời (OFF)</button>

    <div class="depth">
      <label for="depthRange" class="meta">Độ sâu: </label>
      <input id="depthRange" type="range" min="1" max="14" step="1" value="3" aria-label="Độ sâu mở rộng">
      <span id="depthLabel" class="meta">≤ 3 lớp</span>
    </div>
  </div>
</div>

<!-- Floating quick actions for mobile -->
<div class="fabbar" aria-hidden="false">
  <button class="btn" id="fabExpand" type="button">Mở</button>
  <button class="btn" id="fabCollapse" type="button">Thu</button>
  <button class="btn" id="fabReset" type="button">Mặc định</button>
</div>

<div class="wrap">
  <div class="tree" id="tree">

    <!-- ===== DATA: giữ nguyên cấu trúc v4.1, sửa vài lỗi chính tả nhỏ ===== -->

    <!-- Đời 1 -->
    <details open data-gen="1" id="d1">
      <summary class="node"><span class="chev"></span>
        <div>
          <div><strong>Sơn Đông Quận – Bùi Nhật Chiếu</strong> ── Bà Chu Thị Thành <span class="meta">(Đời 1)</span></div>
          <div class="meta">Sinh hạ 8 người con trai (Đời 2)</div>
        </div>
        <span class="count">8</span>
        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
      </summary>

      <div class="children">
        <div class="leaf" data-gen="2">1: <strong>Ông Bùi Phúc Biên</strong> <span class="meta">(Hải Dương) – Đời 2</span></div>
        <div class="leaf" data-gen="2">2: <strong>Ông Bùi Phúc Trân</strong> <span class="meta">(Quỳnh Lưu) – Đời 2</span></div>

        <!-- Bùi Chính Đạo (Đời 2) -->
        <details data-gen="2" open id="d2-3">
          <summary class="node"><span class="chev"></span>
            <div>
              <div><strong>3: Ông Bùi Chính Đạo</strong> <span class="meta">(Quỳnh Lưu) ── Bà Nguyễn Thị Huệ (Đời 2)</span></div>
              <div class="meta">Sinh được 5 con trai (Đời 3)</div>
            </div>
            <span class="count">5</span>
            <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
          </summary>

          <div class="children">

            <!-- Đời 3 -->
            <details data-gen="3" id="d3-1">
              <summary class="node"><span class="chev"></span>
                <div><strong>1: Bùi Chính Trực</strong> <span class="meta">(Quỳnh Lộc + An Hòa) – Đời 3</span></div>
                <span class="count">5 con</span>
                <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
              </summary>
              <div class="children">
                <div class="leaf" data-gen="4"><strong>1: Bùi Phúc Nhuận</strong> <span class="meta">(Quỳnh Lộc, An Hòa) – Đời 4</span></div>
                <div class="leaf" data-gen="4">2: <strong>Bùi Huy Chinh</strong> <span class="meta">(Chết sớm) – Đời 4</span></div>
                <div class="leaf" data-gen="4">3: <strong>Bùi Huy Hộc</strong> <span class="meta">(Chết sớm) – Đời 4</span></div>
                <div class="leaf" data-gen="4">4: <strong>Bùi Huy Đứng</strong> <span class="meta">(Chết sớm) – Đời 4</span></div>
                <div class="leaf" data-gen="4"><strong>5: Bùi Công Uyên</strong> <span class="meta">(Quỳnh Trang) – Đời 4</span></div>

                <!-- Con của Bùi Phúc Nhuận (Đời 5) -->
                <details data-gen="5" id="d5-nhuan">
                  <summary class="node"><span class="chev"></span>
                    <div><strong>Con của 1: Bùi Phúc Nhuận</strong> <span class="meta">– Đời 5</span></div>
                    <span class="count">3</span>
                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                  </summary>
                  <div class="children">
                    <details data-gen="5" id="d5-phap">
                      <summary class="node"><span class="chev"></span>
                        <div><strong>1: Bùi Chính Pháp</strong> <span class="meta">(Quỳnh Lộc) – Đời 5</span></div>
                        <span class="count">4 con (Đời 6)</span>
                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                      </summary>
                      <div class="children">
                        <div class="leaf" data-gen="6"><strong>1: Ông Bùi Công Triêm</strong> <span class="meta">(An Hòa) – Đời 6</span></div>
                        <details data-gen="6" id="d6-man">
                          <summary class="node"><span class="chev"></span>
                            <div><strong>2: Ông Bùi Cẩn Mận</strong> <span class="meta">(An Hòa) – Đời 6</span></div>
                            <span class="count">6 con (Đời 7)</span>
                            <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                          </summary>
                          <div class="children">
                            <div class="leaf" data-gen="7"><strong>1: Bùi Trường</strong> <span class="meta">(Bác Thế) – Đời 7</span></div>

                            <details data-gen="7" id="d7-khien">
                              <summary class="node"><span class="chev"></span>
                                <div><strong>2: Bùi Văn Khiên</strong> <span class="meta">(Ông Thành) ── Bà Tự Cầm Kiệm – Đời 7</span></div>
                                <span class="count">4 con (Đời 8)</span>
                                <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                              </summary>
                              <div class="children">

                                <details data-gen="8" id="d8-hat">
                                  <summary class="node"><span class="chev"></span>
                                    <div><strong>1: Bùi Văn Hát</strong> <span class="meta">(tức Ông Trung Trực) ── Bà Hiệu Từ Liêm – Đời 8</span></div>
                                    <span class="count">5 con (Đời 9)</span>
                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                  </summary>
                                  <div class="children">
                                    <div class="leaf" data-gen="9"><strong>1: Bùi Văn Sắc</strong> <span class="meta">(Nhà thờ Bác Thành) – Đời 9</span></div>

                                    <details data-gen="9" id="d9-so">
                                      <summary class="node"><span class="chev"></span>
                                        <div><strong>2: Bùi Văn Sở</strong> <span class="meta">(Nhà thờ Bác Bình) ── Bà Hiệu Lương Thiện – Đời 9</span></div>
                                        <span class="count">5 con (Đời 10)</span>
                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                      </summary>
                                      <div class="children">
                                        <div class="leaf" data-gen="10"><strong>1: Bùi Thị Tròn</strong> <span class="meta">lấy chồng họ Mai (nay còn cháu là Mai Thị Nga) – Đời 10</span></div>

                                        <details data-gen="10" id="d10-my">
                                          <summary class="node"><span class="chev"></span>
                                            <div><strong>2: Bùi Văn Mỹ</strong> <span class="meta">lấy bà (xuất giá lấy chồng) – Đời 10</span></div>
                                            <span class="count">3 con (Đời 11)</span>
                                            <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                          </summary>
                                          <div class="children">

                                            <details data-gen="11" id="d11-loi">
                                              <summary class="node"><span class="chev"></span>
                                                <div><strong>1: Bùi Văn Lợi</strong> ── Mai Thị Hời – Đời 11</div>
                                                <span class="count">7 con (Đời 12)</span>
                                                <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                              </summary>
                                              <div class="children">

                                                <details data-gen="12" id="d12-binh">
                                                  <summary class="node"><span class="chev"></span>
                                                    <div><strong>1: Bùi Văn Bình</strong> ── Lê Thị Phương – Đời 12</div>
                                                    <span class="count">7 con (Đời 13)</span>
                                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                  </summary>
                                                  <div class="children">

                                                    <details data-gen="13" id="d13-long">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>1: Bùi Văn Long</strong> ── Hồ Thị Hồng – Đời 13</div>
                                                        <span class="count">3 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">1.1: <strong>Bùi Thanh Lam</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.2: <strong>Bùi Quốc Việt</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.3: <strong>Bùi Thị Thảo My</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <div class="leaf" data-gen="13">2: <strong>Bùi Thị Loan</strong> <span class="meta">Đời 13</span></div>
                                                    <div class="leaf" data-gen="13">3: <strong>Bùi Thị Hoa</strong> <span class="meta">Đời 13</span></div>

                                                    <details data-gen="13" id="d13-que">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>4: Bùi Văn Quế</strong> <span class="meta">Đời 13</span></div>
                                                        <span class="count">1 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">4.1: <strong>Bùi Thị Tiểu Vy</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <div class="leaf" data-gen="13">5: <strong>Bùi Thị Huệ</strong> <span class="meta">Đời 13</span></div>
                                                    <div class="leaf" data-gen="13">6: <strong>Bùi Thị Lan</strong> ── Hồ Văn Tuấn <span class="meta">Đời 13</span></div>
                                                    <div class="leaf" data-gen="13">7: <strong>Bùi Thị Thanh</strong> ── Hồ Hữu Hai <span class="meta">Đời 13</span></div>
                                                  </div>
                                                </details>

                                                <div class="leaf" data-gen="12">2: <strong>Bùi Văn Tịnh</strong> <span class="meta">(Liệt Sỹ) – Đời 12</span></div>

                                                <details data-gen="12" id="d12-vinh">
                                                  <summary class="node"><span class="chev"></span>
                                                    <div><strong>3: Bùi Văn Vinh</strong> ── Mai Thị Thiêm – Đời 12</div>
                                                    <span class="count">4 con (Đời 13)</span>
                                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                  </summary>
                                                  <div class="children">

                                                    <details data-gen="13" id="d13-oai">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>1: Bùi Quốc Oai</strong> ── Lê Thị Tuấn Anh – Đời 13</div>
                                                        <span class="count">2 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">1.1: <strong>Bùi Văn Quốc Huy</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.2: <strong>Bùi Thị Hoài An</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <details data-gen="13" id="d13-cuong">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>2: Bùi Văn Cường</strong> ── Hồ Thị Thanh – Đời 13</div>
                                                        <span class="count">3 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">2.1: <strong>Bùi Thị Trà My</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">2.2: <strong>Bùi Thị Thảo Vy</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">2.3: <strong>Bùi Thị Ngọc Ánh</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <details data-gen="13" id="d13-hien">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>3: Bùi Văn Hiển</strong> ── Hồ Thị Thủy – Đời 13</div>
                                                        <span class="count">2 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">3.1: <strong>Bùi Văn Sang</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">3.2: <strong>Bùi Văn Tài</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <details data-gen="13" id="d13-quy">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>4: Bùi Văn Quỹ</strong> ── Lê Thị Thảo – Đời 13</div>
                                                        <span class="count">1 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">4.1: <strong>Bùi Thiện Nhân</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>
                                                  </div>
                                                </details>

                                                <details data-gen="12" id="d12-tien">
                                                  <summary class="node"><span class="chev"></span>
                                                    <div><strong>5: Bùi Văn Tiến</strong> ── Lê Thị Vinh – Đời 12</div>
                                                    <span class="count">2 con (Đời 13)</span>
                                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                  </summary>
                                                  <div class="children">

                                                    <details data-gen="13" id="d13-cong">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>1: Bùi Văn Công</strong> <span class="meta">2 vợ: Hồ Thị Quyên; Ngô Thị Thu – Đời 13</span></div>
                                                        <span class="count">2 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">1.1: <strong>Bùi Minh Đan</strong> <span class="meta">(con vợ 1) – Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.2: <strong>Bùi Minh Tâm</strong> <span class="meta">(con vợ 2) – Đời 14</span></div>
                                                      </div>
                                                    </details>

                                                    <details data-gen="13" id="d13-linh">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>2: Bùi Văn Linh</strong> ── Hồ Thị Cần – Đời 13</div>
                                                        <span class="count">2 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">2.1: <strong>Bùi Minh Đức</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">2.2: <strong>Bùi Văn Khánh</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>
                                                  </div>
                                                </details>

                                                <details data-gen="12" id="d12-hung">
                                                  <summary class="node"><span class="chev"></span>
                                                    <div><strong>6: Bùi Văn Hùng</strong> ── Cao Thị Duyên – Đời 12</div>
                                                    <span class="count">3 con (Đời 13)</span>
                                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                  </summary>
                                                  <div class="children">
                                                    <details data-gen="13" id="d13-manh">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>1: Bùi Văn Mạnh</strong> ── Hoàng Thị Thanh – Đời 13</div>
                                                        <span class="count">4 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">1.1: <strong>Bùi Văn Nam</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.2: <strong>Bùi Thị Trâm</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.3: <strong>Bùi Minh Quân</strong> <span class="meta">Đời 14</span></div>
                                                        <div class="leaf" data-gen="14">1.4: <strong>Bùi Minh Khoa</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>
                                                    <div class="leaf" data-gen="13">2: <strong>Bùi Văn Trung</strong> <span class="meta">Đời 13</span></div>
                                                    <div class="leaf" data-gen="13">3: <strong>Bùi Thị Nga</strong> <span class="meta">Đời 13</span></div>
                                                  </div>
                                                </details>

                                                <details data-gen="12" id="d12-dung">
                                                  <summary class="node"><span class="chev"></span>
                                                    <div><strong>7: Bùi Văn Dụng</strong> ── Hoàng Tị Thuận – Đời 12</div>
                                                    <span class="count">2 con (Đời 13)</span>
                                                    <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                  </summary>
                                                  <div class="children">
                                                    <details data-gen="13" id="d13-ba">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>1: Bùi Văn Ba</strong> ── Hồ Thị Loan – Đời 13</div>
                                                        <span class="count">1 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">1.1: <strong>Bùi Linh Chị</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>
                                                    <details data-gen="13" id="d13-hoang">
                                                      <summary class="node"><span class="chev"></span>
                                                        <div><strong>2: Bùi Văn Hoàng</strong> ── Nguyên Thị Thơ – Đời 13</div>
                                                        <span class="count">1 con (Đời 14)</span>
                                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                                      </summary>
                                                      <div class="children">
                                                        <div class="leaf" data-gen="14">2.1: <strong>Bùi Hải Đăng</strong> <span class="meta">Đời 14</span></div>
                                                      </div>
                                                    </details>
                                                  </div>
                                                </details>

                                              </div>
                                            </details>

                                            <div class="leaf" data-gen="11">2: <strong>Bùi Văn Cát</strong> <span class="meta">Đời 11</span></div>

                                            <details data-gen="11" id="d11-bat">
                                              <summary class="node"><span class="chev"></span>
                                                <div><strong>3: Bùi Văn Bát</strong> ── Nguyễn Thị Định – Đời 11</div>
                                                <span class="count">10 con (Đời 12)</span>
                                                <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                              </summary>
                                              <div class="children">
                                                <div class="leaf" data-gen="12">1: <strong>Bùi Thị Tuyết</strong> (..)</div>
                                                <div class="leaf" data-gen="12">2: <strong>Bùi Thị Tính</strong> ── Hồ Hữu Diễn</div>
                                                <div class="leaf" data-gen="12">3: <strong>Bùi Thị Hạnh</strong> ── Nguyễn Hữu Hạnh</div>
                                                <div class="leaf" data-gen="12">4: <strong>Bùi Thị Phúc</strong> ── Hồ Hữu Phượng</div>
                                                <div class="leaf" data-gen="12">5: <strong>Bùi Văn Lại</strong> ── Mai Thị Thiết</div>
                                                <div class="leaf" data-gen="12">6: <strong>Bùi Văn Lời</strong> ── Nguyễn Thị Hương</div>
                                                <div class="leaf" data-gen="12">7: <strong>Bùi Văn Vinh</strong> ── Mai Thị Công</div>
                                                <div class="leaf" data-gen="12">8: <strong>Bùi Văn Văn</strong></div>
                                                <div class="leaf" data-gen="12">9: <strong>Bùi Văn Luận</strong> ── Mai Thị Hiền <span class="meta">(mất tích)</span></div>
                                                <div class="leaf" data-gen="12">10: <strong>Bùi Văn Thập</strong></div>
                                              </div>
                                            </details>
                                          </div>
                                        </details>

                                        <div class="leaf" data-gen="10">3: <strong>Bùi Văn Thượt</strong> <span class="meta">(Chết sớm) – Đời 10</span></div>
                                        <div class="leaf" data-gen="10">4: <strong>Bùi Văn Kỷ</strong> <span class="meta">(Chết sớm) – Đời 10</span></div>
                                      </div>
                                    </details>

                                    <div class="leaf" data-gen="9">3: <strong>Bùi Văn Cu</strong> <span class="meta">(Chết sớm) – Đời 9</span></div>
                                    <div class="leaf" data-gen="9">4: <strong>Bùi Văn HUY</strong> <span class="meta">(Chết sớm) – Đời 9</span></div>

                                    <details data-gen="9" id="d9-duc">
                                      <summary class="node"><span class="chev"></span>
                                        <div><strong>5: Bùi Văn Đức</strong> ── Bà Hiệu Cầm Kiệm – Đời 9</div>
                                        <span class="count">6 con (Đời 10)</span>
                                        <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                      </summary>
                                      <div class="children">
                                        <div class="leaf" data-gen="10">1: <strong>Bùi Văn Nhân</strong> <span class="meta">(Chết sớm)</span></div>
                                        <div class="leaf" data-gen="10">2: <strong>Bùi Thị Ngại</strong> <span class="meta">(Lấy chồng vô tự)</span></div>

                                        <details data-gen="11" id="d11-khuong">
                                          <summary class="node"><span class="chev"></span>
                                            <div><strong>3: Bùi Văn Khuông</strong> <span class="meta">lấy hai bà: Mai Thị Sang / Mai Thị Nghi – Đời 11</span></div>
                                            <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                          </summary>
                                          <div class="children">
                                            <div class="leaf" data-gen="11">• Bà Mai Thị Sang sinh <strong>Bùi Thị Lan</strong> ── Hồ Hữu Tươi <span class="meta">(Ngọc Sơn)</span></div>
                                            <div class="leaf" data-gen="11">• Bà Mai Thị Nghi sinh <strong>Bùi Văn Huệ</strong></div>

                                            <details data-gen="12" id="d12-hue">
                                              <summary class="node"><span class="chev"></span>
                                                <div><strong>Bùi Nguyễn Huệ</strong> ── Phạm Thị Nhu – Đời 12</div>
                                                <span class="count">4 con</span>
                                                <div class="actions"><button class="mini focus-btn" type="button">🎯 Focus</button><button class="mini link-btn" type="button">🔗 Liên kết</button></div>
                                              </summary>
                                              <div class="children">
                                                <div class="leaf" data-gen="12">1: <strong>Bùi Nguyễn Tuấn</strong> <span class="meta">(Diễn Hoàng Diễn Châu)</span></div>
                                                <div class="leaf" data-gen="12">2: <strong>Bùi Nguyễn Trung</strong> <span class="meta">(Diễn Hoàng Diễn Châu)</span></div>
                                                <div class="leaf" data-gen="12">3: <strong>Bùi Nguyễn Thị Dung</strong></div>
                                                <div class="leaf" data-gen="12">4: <strong>Bùi Nguyễn Hùng</strong></div>
                                              </div>
                                            </details>
                                          </div>
                                        </details>

                                        <div class="leaf" data-gen="10">4: <strong>Bùi Thị Bích</strong> <span class="meta">(Chết sớm)</span></div>
                                        <div class="leaf" data-gen="10">5: <strong>Bùi Thị Hỷ</strong> <span class="meta">(Chết sớm)</span></div>
                                        <div class="leaf" data-gen="10">6: <strong>Bùi Văn Vuông</strong> <span class="meta">(Chết sớm)</span></div>
                                      </div>
                                    </details>
                                  </div>
                                </details>

                                <div class="leaf" data-gen="8">2: <strong>Bùi Nhị Lang</strong> <span class="meta">(Chết sớm) – Đời 8</span></div>
                                <div class="leaf" data-gen="8">3: <strong>Bùi Tam Lang</strong> <span class="meta">(Chết sớm) – Đời 8</span></div>
                                <div class="leaf" data-gen="8">4: <strong>Bùi Thị Ma</strong> <span class="meta">(Chết sớm) – Đời 8</span></div>
                              </div>
                            </details>

                            <div class="leaf" data-gen="7">3: <strong>Bùi Đức Bởi</strong> <span class="meta">(Ông Thức) – Đời 7</span></div>
                            <div class="leaf" data-gen="7">4: <strong>Bùi Văn Hai</strong> <span class="meta">(Vô Tự) – Đời 7</span></div>
                            <div class="leaf" data-gen="7">5: <strong>Bùi Văn Cúc</strong> <span class="meta">(Ông Cam) – Đời 7</span></div>
                            <div class="leaf" data-gen="7">6: <strong>Bùi Văn Khoa</strong> <span class="meta">(Làm con nuôi ở Quỳnh Minh) – Đời 7</span></div>
                          </div>
                        </details>

                        <div class="leaf" data-gen="6"><strong>3: Ông Bùi Huy Đan</strong> <span class="meta">(An Hòa) – Đời 6</span></div>
                        <div class="leaf" data-gen="6"><strong>4: Bùi Huy Quang</strong> <span class="meta">(An Hòa) – Đời 6</span></div>
                      </div>
                    </details>

                    <div class="leaf" data-gen="5"><strong>2: Bùi Công Hoán</strong> <span class="meta">(Quỳnh Lộc) – Đời 5</span></div>
                    <div class="leaf" data-gen="5"><strong>3: Bùi Huy Điềm</strong> <span class="meta">(Quỳnh Lộc) – Đời 5</span></div>
                  </div>
                </details>
              </div>
            </details>

            <div class="leaf" data-gen="3">2: <strong>Bùi Thiên Chí</strong> <span class="meta">(Quỳnh Nghĩa, Ngọc Lâm) – Đời 3</span></div>
            <div class="leaf" data-gen="3">3: <strong>Bùi Lẫm</strong> <span class="meta">(Quỳnh Lương) – Đời 3</span></div>
            <div class="leaf" data-gen="3">4: <strong>Bùi Đức Thủy</strong> <span class="meta">(Quỳnh Yên + Bắc Lợi) – Đời 3</span></div>
            <div class="leaf" data-gen="3">5: <strong>Bùi Chính Thiện</strong> <span class="meta">(Trúc Vọng Quỳnh Lương) – Đời 3</span></div>
          </div>
        </details>

        <div class="leaf" data-gen="2">4: <strong>Ông Bùi Phúc Lan</strong> <span class="meta">(Chưa Biết) – Đời 2</span></div>
        <div class="leaf" data-gen="2">5: <strong>Ông Bùi Phúc Nginh</strong> <span class="meta">(Diễn Châu) – Đời 2</span></div>
        <div class="leaf" data-gen="2">6: <strong>Ông Bùi Tiên Tiến</strong> <span class="meta">(Nghi Lộc) – Đời 2</span></div>
        <div class="leaf" data-gen="2">7: <strong>Ông Bùi Phúc Chân</strong> <span class="meta">(Hưng Nguyên) – Đời 2</span></div>
        <div class="leaf" data-gen="2">8: <strong>Ông Bùi Phúc Tương</strong> <span class="meta">(Chưa Biết) – Đời 2</span></div>
      </div>
    </details>
  </div>
</div>

<script>
// ===== Utilities =====
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const store = {
  get(){ try{ return JSON.parse(localStorage.getItem('buiTreeState')||'{}'); }catch(e){ return {}; } },
  set(obj){ localStorage.setItem('buiTreeState', JSON.stringify(obj)); }
};

// ===== Gen bar logic =====
const genbar = document.getElementById('genbar');
const allGenSet = new Set(Array.from({length:14}, (_,i)=>(i+1).toString()));
let activeGens = new Set([...allGenSet]);
let singleMode = false;
let compact = false;
let focusTarget = null; // id of focused details

function renderGenButtons(){
  genbar.innerHTML = '';
  for(let i=1;i<=14;i++){
    const btn = document.createElement('button');
    btn.className = 'gbtn ' + (activeGens.has(String(i)) ? 'active' : '');
    btn.dataset.gen = String(i);
    btn.textContent = 'Đời ' + i;
    btn.type = 'button';
    btn.onclick = () => {
      const g = btn.dataset.gen;
      if(singleMode){
        activeGens = new Set([g]);
      }else{
        if(activeGens.has(g)){ activeGens.delete(g); }
        else{ activeGens.add(g); }
      }
      renderGenButtons();
      applyGenFilter();
      persist();
    };
    genbar.appendChild(btn);
    if(i===7 || i===10) {
      const sep = document.createElement('div');
      sep.className = 'sep';
      genbar.appendChild(sep);
    }
  }
}

function applyGenFilter(){
  const all = document.querySelectorAll('[data-gen]');
  all.forEach(el => {
    const g = el.getAttribute('data-gen');
    el.classList.toggle('hidden', !activeGens.has(g));
  });
  // Keep parents of visible nodes visible & open for context
  document.querySelectorAll('[data-gen]').forEach(el=>{
    if(!el.classList.contains('hidden') && el.tagName.toLowerCase()==='details'){
      let p = el.parentElement.closest('details');
      while(p){ p.open = true; p.classList.remove('hidden'); p = p.parentElement.closest('details'); }
    }
  });
}

// ===== Expand / Collapse / Depth =====
const detailsList = () => $$('details');

function setDepth(maxDepth){
  // data-depth computed from nesting level
  detailsList().forEach(d => {
    const depth = parseInt(d.getAttribute('data-depth')||'1',10);
    d.open = (depth <= maxDepth);
  });
}

function computeDepth(){
  const roots = $$('details:not(details details)');
  const walk = (node, depth) => {
    node.setAttribute('data-depth', depth);
    $$(':scope > .children > details', node).forEach(ch => walk(ch, depth+1));
  };
  roots.forEach(r => walk(r, 1));
}

// ===== Search with highlight + auto-open =====
const q = document.getElementById('q'); const clearBtn = document.getElementById('clear');
function normalize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function clearMarks(){
  $$('mark').forEach(m=>{
    const t = document.createTextNode(m.textContent);
    m.parentNode.replaceChild(t, m);
    m.parentNode.normalize();
  });
}
function highlightFirst(el, term){
  const txt = el.textContent;
  const idx = normalize(txt).indexOf(term);
  if(idx < 0) return false;
  const before = txt.slice(0, idx);
  const mid = txt.slice(idx, idx + term.length);
  const after = txt.slice(idx + term.length);
  el.innerHTML = ''; 
  el.append(before, Object.assign(document.createElement('mark'), {textContent: mid}), after);
  return true;
}
function search(){
  clearMarks();
  const term = normalize(q.value.trim());
  const nodes = $$('.node, .leaf');
  if(!term){
    nodes.forEach(el => el.style.opacity='');
    return;
  }
  nodes.forEach(el => {
    const txt = normalize(el.textContent);
    const hit = txt.includes(term);
    el.style.opacity = hit ? '' : '.25';
    if(hit){
      let p = el.closest('details');
      while(p){ p.open = true; p = p.parentElement?.closest('details'); }
      // mark main text
      if(el.classList.contains('node')){
        const main = el.querySelector('div');
        if(main) highlightFirst(main, term);
      }
    }
  });
}

// ===== Focus branch & copy link =====
function clearFocus(){
  $$('.focus-dim').forEach(el=>el.classList.remove('focus-dim'));
  focusTarget = null;
  persist();
}
function applyFocus(id){
  clearFocus();
  focusTarget = id;
  const target = document.getElementById(id);
  if(!target) return;
  // open all parents
  let p = target;
  while(p){ p.open = true; p = p.parentElement?.closest('details'); }
  // dim others
  $$('.tree > details, .tree details details, .leaf').forEach(el=>{
    if(!el.closest('#'+id) && el.id !== id){
      el.classList.add('focus-dim');
    }
  });
  // scroll into view
  target.scrollIntoView({behavior:'smooth', block:'start'});
  persist();
}
function findDetailsFromButton(btn){
  return btn.closest('details');
}
async function copyLinkFor(el){
  const id = el.id || ('node-' + Math.random().toString(36).slice(2,8));
  el.id = id;
  const url = location.href.split('#')[0] + '#' + id;
  try{
    await navigator.clipboard.writeText(url);
    alert('Đã sao chép liên kết tới nhánh.');
  }catch(e){
    // fallback
    prompt('Sao chép liên kết:', url);
  }
}

// ===== State persistence =====
function persist(){
  const openIds = detailsList().filter(d => d.open).map(d => d.id).filter(Boolean);
  const state = {
    activeGens:[...activeGens],
    singleMode,
    compact:document.body.classList.contains('compact'),
    focusTarget,
    openIds
  };
  store.set(state);
}
function restore(){
  const s = store.get();
  if(s.activeGens){
    activeGens = new Set(s.activeGens);
  }
  if(s.singleMode){
    singleMode = true;
    $('#singleModeBtn').setAttribute('aria-pressed','true');
    $('#singleModeBtn').textContent = 'Chế độ chỉ đời (ON)';
  }
  if(s.compact){ document.body.classList.add('compact'); }
  renderGenButtons();
  applyGenFilter();
  computeDepth();
  if(s.openIds){
    s.openIds.forEach(id => { const d = document.getElementById(id); if(d) d.open = true; });
  }
  if(s.focusTarget){ applyFocus(s.focusTarget); }
}

// ===== Wire up controls =====
function init(){
  renderGenButtons();
  applyGenFilter();
  computeDepth();

  // Top buttons
  $('#showAllGen').onclick = () => {
    activeGens = new Set([...allGenSet]);
    singleMode = false;
    $('#singleModeBtn').setAttribute('aria-pressed','false');
    $('#singleModeBtn').textContent = 'Chế độ chỉ đời (OFF)';
    renderGenButtons();
    applyGenFilter();
    persist();
  };
  $('#singleModeBtn').onclick = (e) => {
    singleMode = !singleMode;
    e.currentTarget.setAttribute('aria-pressed', singleMode ? 'true' : 'false');
    e.currentTarget.textContent = singleMode ? 'Chế độ chỉ đời (ON)' : 'Chế độ chỉ đời (OFF)';
    renderGenButtons();
    applyGenFilter();
    persist();
  };
  $('#expand').onclick = () => { detailsList().forEach(d => d.open = true); persist(); };
  $('#collapse').onclick = () => { detailsList().forEach(d => d.open = false); persist(); };
  $('#toggleCompact').onclick = () => { document.body.classList.toggle('compact'); persist(); };

  // FAB quick actions
  $('#fabExpand').onclick = () => { detailsList().forEach(d => d.open = true); persist(); };
  $('#fabCollapse').onclick = () => { detailsList().forEach(d => d.open = false); persist(); };
  $('#fabReset').onclick = () => { localStorage.removeItem('buiTreeState'); location.reload(); };

  // Depth slider
  const rng = $('#depthRange'); const lab = $('#depthLabel');
  const upd = ()=>{ lab.textContent = '≤ ' + rng.value + ' lớp'; setDepth(parseInt(rng.value,10)); persist(); };
  rng.addEventListener('input', upd, {passive:true});
  upd();

  // Search
  q.addEventListener('input', search, {passive:true});
  $('#clear').onclick = () => { q.value=''; search(); q.focus(); };

  // Delegate mini buttons
  document.body.addEventListener('click', (e)=>{
    const btn = e.target;
    if(btn.classList.contains('focus-btn')){
      const d = findDetailsFromButton(btn);
      if(d){ applyFocus(d.id || (d.id = 'node-' + Math.random().toString(36).slice(2,8))); }
    }else if(btn.classList.contains('link-btn')){
      const d = findDetailsFromButton(btn);
      if(d){ copyLinkFor(d); }
    }
  });

  // Deep link on load/hash change
  function openHash(){
    const id = location.hash.slice(1);
    if(!id) return;
    const el = document.getElementById(id);
    if(el){
      let p = el;
      while(p){ if(p.tagName==='DETAILS') p.open = true; p = p.parentElement?.closest('details'); }
      el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
  window.addEventListener('hashchange', openHash);
  openHash();

  restore();
}
document.addEventListener('DOMContentLoaded', init, {once:true});
</script>
</body>
</html>
